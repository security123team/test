name: ZAP Security Scan
on:
  push:
    branches:
      - main
jobs:
  zap_scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
        - "https://bitscrunch.com/"
        - "https://app.bitscrunch.com/"
    name: Scan ${{ matrix.target }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Create Ignore Rules File
        run: |
          mkdir -p .zap
          echo "10035    # Strict-Transport-Security Disabled" > .zap/ignore-rules.tsv
          echo "10038    # Content Security Policy (CSP) Header Not Set" >> .zap/ignore-rules.tsv
          echo "10096    # Timestamp Disclosure - Unix" >> .zap/ignore-rules.tsv
          echo "40025    # Proxy Disclosure" >> .zap/ignore-rules.tsv
        shell: bash
      - name: Extract Domain Name
        id: extract_domain
        run: |
          DOMAIN=$(echo "${{ matrix.target }}" | sed -E 's|https?://([^/]+).*|\1|')
          echo "Extracted Domain: $DOMAIN"
          echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV
      - name: Run ZAP Scan
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          token: ${{ secrets.TOKEN }}
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          target: ${{ matrix.target }}
          rules_file_name: '.zap/ignore-rules.tsv'
          cmd_options: '-a'
      - name: Save ZAP Report
        run: |
          mkdir -p zap-reports
          mv report_html.html zap-reports/zap_report_${{ env.DOMAIN }}.html
      - name: Upload ZAP Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-reports-${{ env.DOMAIN }}
          path: zap-reports/
